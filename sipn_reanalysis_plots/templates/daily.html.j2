{# Expects params:

   - date: Date of interest
   - min_date: Minimum selectable date
   - max_date: Maximum selectable date
   - variables: Dict of all variables and their associated levels & long_name
   - variable: Optional name of selected variable
   - level: Optional id of selected level
   - img_data: Optional base64-encoded png image data
#}
{% extends 'base.html.j2' %}
{% from 'macros/forms.j2' import daily_plot_form_fields %}
{% from 'macros/plot.j2' import plot_img %}


{% block title %}Daily{% endblock %}

{% block content %}
  <div style="width: 1000px">
    <form method="GET">
      {{daily_plot_form_fields(form)}}
    </form>
  </div>

  {{plot_img(img_data)}}

  <script>
    let variables = JSON.parse('{{variables | tojson | safe}}');
    let varsDropdown = document.querySelector('#{{form.variable.id}}');
    let levelsDropdown = document.querySelector('#{{form.analysis_level.id}}');
    let selectedLevel = '{{form.analysis_level.data}}';

    function handleVariableLevels() {
      // Clear the levels dropdown
      for (o in levelsDropdown.options ) {
        levelsDropdown.options.remove(o);
      }

      selectedVariable = varsDropdown.value;

      // Populate the levels dropdown
      let selectedVariableLevels = variables[selectedVariable].levels;
      selectedVariableLevels.forEach(function(item, index) {
        let newOpt = document.createElement('option');
        newOpt.label = item;
        newOpt.value = index;
        newOpt.selected = index === Number(selectedLevel);

        levelsDropdown.appendChild(newOpt);
      });
    }

    varsDropdown.addEventListener('change', handleVariableLevels);
    handleVariableLevels();
  </script>
{% endblock %}
